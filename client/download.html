<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <style>
            .container {
                width: 90%;
                margin: auto;
                display: flex;
                flex-direction: column;
            }
            .img-item {
                border: 10px solid white;
                box-sizing: border-box;
                box-shadow: 0.3em 0.3em 1em rgba(0,0,0,0.3);
                margin-bottom: 50px;
                width: 100%;
                height: auto;
            }
        </style>
    </head>
    <body>
        <div class="container">
            
        </div>
        <script>
            const baseUrl = 'http://localhost:3000'
            function status(response) {
                if (response.ok) {
                    return Promise.resolve(response)
                } else {
                    return Promise.reject(new Error(response.statusText))
                }
            }
            function fetchImageList() {
                return new Promise((resolve, reject) => {
                    fetch(baseUrl + '/imageList', {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                      .then(status)
                      .then(response => {
                          return response.json()
                      })
                      .then(resolve)
                      .catch(reject)
                })
            }

            function downloadImage(data) {
                return new Promise((resolve, reject) => {
                    fetch(baseUrl + data.url, {
                        method: 'Get',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'image/jpeg'
                        }
                    })
                      .then(status)
                      .then(response => {
                          return response.blob()
                      })
                      .then(imageBlob => {
                          resolve({blob: imageBlob, id: data.id})
                      })
                      .catch(reject)
                })
            }

            function loadImage(list) {
                // 创建img元素
                const container = document.getElementsByClassName('container')[0]
                list.forEach(data => {
                    const img = document.createElement('img')
                    img.setAttribute('id', data.id)
                    img.setAttribute('class', 'img-item')
                    container.appendChild(img)
                })

                list.map(downloadImage).reduce((sequence, promise) => {
                    return sequence.then(() => {
                        return promise
                    }).then(imageData => {
                        document.getElementById(imageData.id).src = URL.createObjectURL(imageData.blob)
                    })
                }, Promise.resolve())
            }

            window.onload = function() {
                fetchImageList()
                  .then(loadImage)
                  .catch(error => {
                      console.log(error)
                  })
            }
        </script>
    </body>
</html>